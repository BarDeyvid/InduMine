name: Update Commit Leaderboard

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  leaderboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: Generate leaderboard
        run: |
          # 1. Get the log. We use -e to ensure we see the email.
          git shortlog -sn -e --since="30 days ago" main > leaderboard.txt
          
          echo "## Commit Leaderboard (Ãºltimos 30 dias)" > leaderboard.md
          echo "" >> leaderboard.md
          echo "| Rank | Commits | Author |" >> leaderboard.md
          echo "|------|---------|--------|" >> leaderboard.md
          
          # 2. AWK with "Identity Force"
          awk '{
              count=$1; 
              $1=""; 
              line=$0; 
              # Remove the email part <...>
              sub(/ <.*>/, "", line); 
              name=substr(line,2);
              # Trim spaces
              gsub(/^[ \t]+|[ \t]+$/, "", name);
              
              # MANUALLY MERGE ALL YOUR KNOWN ALIASES
              if (name == "BarDeyvid" || name == "ddeyvid" || name == "Deyvid") {
                  name = "Deyvid Barcelos";
              }
              if (name == "luclc13241") {
                  name = "Lucas Cardoso";
              }
              if (name == "kauamdsouza") {
                  name = "Kauan Souza";
              }
              
              scores[name] += count;
          } END {
              n = 0;
              for (name in scores) {
                  n++;
                  names[n] = name;
              }
              # Sort by commit count descending
              for (i = 1; i <= n; i++) {
                  for (j = i + 1; j <= n; j++) {
                      if (scores[names[j]] > scores[names[i]]) {
                          tmp = names[i];
                          names[i] = names[j];
                          names[j] = tmp;
                      }
                  }
              }
              for (i = 1; i <= n; i++) {
                  print "| " i " | " scores[names[i]] " | " names[i] " |";
              }
          }' leaderboard.txt >> leaderboard.md

      - name: Push to Orphan Branch
        run: |
          # 1. Create a temporary folder and move the result there
          mkdir tmp_data
          cp leaderboard.md tmp_data/
          
          # 2. Switch to a completely empty "orphan" branch
          git checkout --orphan leaderboard-data
          
          # 3. Remove all files tracked from main (this doesn't delete them from main branch)
          git rm -rf .
          
          # 4. Move the leaderboard back and commit
          mv tmp_data/leaderboard.md .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add leaderboard.md
          git commit -m "Update leaderboard [skip ci]"
          
          # 5. Force push the single file to the remote branch
          git push origin leaderboard-data --force
